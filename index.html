<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æƒ…ä¾£AIåŠ©æ‰‹ - äº‘ç«¯èŠå¤©ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'love-pink': '#EC4899',
                        'love-purple': '#8B5CF6',
                        'love-blue': '#3B82F6'
                    }
                }
            }
        }
    </script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #EC4899 0%, #8B5CF6 50%, #3B82F6 100%);
        }
        .heart-beat {
            animation: heartBeat 1.5s ease-in-out infinite;
        }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.1); }
            28% { transform: scale(1); }
            42% { transform: scale(1.1); }
            70% { transform: scale(1); }
        }
        .message-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- ç”¨æˆ·é€‰æ‹©ç•Œé¢ -->
    <div id="userSelection" class="min-h-screen flex items-center justify-center p-4">
        <div class="text-center">
            <div class="gradient-bg rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center">
                <span class="text-4xl text-white heart-beat">ğŸ’•</span>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">æƒ…ä¾£AIåŠ©æ‰‹</h1>
            <p class="text-gray-600 dark:text-gray-300 mb-2">äº‘ç«¯å®æ—¶èŠå¤©ç‰ˆ</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-8">ğŸŒ çœŸæ­£çš„å®æ—¶èŠå¤© | ğŸ¤– DeepSeek AI | â˜ï¸ äº‘ç«¯åŒæ­¥</p>
            
            <div class="space-y-4 max-w-sm mx-auto">
                <button onclick="selectUser('boyfriend')" 
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white rounded-lg py-4 px-6 text-lg font-semibold transition-colors">
                    ğŸ¤µ æˆ‘æ˜¯ç”·å‹
                </button>
                <button onclick="selectUser('girlfriend')" 
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white rounded-lg py-4 px-6 text-lg font-semibold transition-colors">
                    ğŸ‘© æˆ‘æ˜¯å¥³å‹
                </button>
            </div>
        </div>
    </div>

    <!-- é…ç½®ç•Œé¢ -->
    <div id="configPanel" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">äº‘ç«¯åŠ©æ‰‹é…ç½®</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        ä½ çš„åå­—
                    </label>
                    <input type="text" id="userName" placeholder="è¾“å…¥ä½ çš„åå­—" 
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        å¯¹æ–¹çš„åå­—
                    </label>
                    <input type="text" id="partnerName" placeholder="è¾“å…¥TAçš„åå­—" 
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        åœ¨ä¸€èµ·çš„æ—¥æœŸ
                    </label>
                    <input type="date" id="anniversaryDate" 
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>

                <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-lg p-3">
                    <div class="flex items-center space-x-2">
                        <span class="text-green-600">âœ…</span>
                        <span class="text-green-700 dark:text-green-300 text-sm">AIå’Œäº‘ç«¯èŠå¤©å·²é…ç½®å®Œæˆ</span>
                    </div>
                </div>
                
                <button onclick="saveConfig()" 
                        class="w-full gradient-bg text-white rounded-lg py-4 font-semibold transition-colors">
                    ğŸ’• å¼€å§‹äº‘ç«¯ä¹‹æ—…
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" class="hidden">
        <!-- å¤´éƒ¨ -->
        <div class="gradient-bg text-white p-4 shadow-lg">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <span id="userIcon" class="text-xl"></span>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg" id="appTitle"></h1>
                        <p class="text-sm opacity-90" id="subtitle"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="connectionStatus" class="text-xs bg-white/20 px-2 py-1 rounded">
                        <span id="connectionStatusText">ğŸŒ äº‘ç«¯è¿æ¥ä¸­</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-md mx-auto">
            <!-- äº‘ç«¯å®æ—¶èŠå¤© -->
            <div class="m-4 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg text-gray-800 dark:text-white flex items-center">
                        ğŸ’¬ äº‘ç«¯èŠå¤©
                    </h3>
                    <div class="flex items-center space-x-2">
                        <div id="chatStatus" class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-700">
                            <span id="chatStatusText">æœªè¿æ¥</span>
                        </div>
                        <button onclick="showChatSettings()" class="text-gray-500 hover:text-gray-700">âš™ï¸</button>
                    </div>
                </div>
                
                <div id="chatContainer">
                    <!-- æœªè¿æ¥çŠ¶æ€ -->
                    <div id="chatNotConnected" class="text-center py-6">
                        <div class="text-4xl mb-4">ğŸ’•</div>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            å¼€å§‹ä¸ <span id="partnerNameInChat">TA</span> çš„äº‘ç«¯èŠå¤©
                        </p>
                        <div class="flex space-x-2">
                            <button onclick="createChatRoom()" 
                                    class="flex-1 gradient-bg text-white rounded-lg py-2 font-semibold">
                                ğŸ”— åˆ›å»ºèŠå¤©å®¤
                            </button>
                            <button onclick="joinChatRoom()" 
                                    class="flex-1 border-2 border-love-pink text-love-pink rounded-lg py-2 font-semibold">
                                ğŸ“ åŠ å…¥èŠå¤©å®¤
                            </button>
                        </div>
                    </div>
                    
                    <!-- å·²è¿æ¥çŠ¶æ€ -->
                    <div id="chatConnected" class="hidden">
                        <div id="chatMessages" class="h-48 overflow-y-auto bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-3 space-y-2">
                            <!-- èŠå¤©æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." 
                                   class="flex-1 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <button onclick="sendCloudMessage()" 
                                    class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold">
                                å‘é€
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center flex justify-between">
                            <span id="onlineStatus">ğŸ’• å®æ—¶åŒæ­¥ä¸­</span>
                            <span id="messageCount">0 æ¡æ¶ˆæ¯</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AIæ™ºèƒ½å»ºè®® -->
            <div class="m-4 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg text-gray-800 dark:text-white flex items-center">
                        ğŸ¤– DeepSeek AIå»ºè®®
                    </h3>
                    <div class="flex space-x-2">
                        <span id="aiCostEstimate" class="text-xs text-gray-500"></span>
                    </div>
                </div>
                <div id="aiSuggestions">
                    <div class="text-gray-600 dark:text-gray-400 text-center py-4">
                        æ­£åœ¨åˆå§‹åŒ–AIåŠ©æ‰‹...
                    </div>
                </div>
                <div class="flex space-x-2 mt-3">
                    <button onclick="generateAISuggestions()" 
                            class="flex-1 gradient-bg text-white rounded-lg py-2 font-semibold flex items-center justify-center space-x-2">
                        <span>ğŸ§ </span>
                        <span>AIæ™ºèƒ½å»ºè®®</span>
                    </button>
                    <button onclick="askCustomAI()" 
                            class="px-4 py-2 border-2 border-love-pink text-love-pink rounded-lg font-semibold hover:bg-love-pink hover:text-white transition-colors">
                        ğŸ’¬
                    </button>
                </div>
            </div>

            <!-- ä»Šæ—¥æé†’ -->
            <div class="m-4 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                <h3 class="font-bold text-lg text-gray-800 dark:text-white mb-3 flex items-center">
                    ğŸ“… ä»Šæ—¥æé†’
                </h3>
                <div id="dailyReminders" class="space-y-2">
                    <!-- åŠ¨æ€ç”Ÿæˆæé†’å†…å®¹ -->
                </div>
            </div>

            <!-- åŠŸèƒ½æŒ‰é’® -->
            <div class="m-4 grid grid-cols-2 gap-4">
                <button onclick="showGiftSuggestions()" 
                        class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 text-center hover:scale-105 transition-transform">
                    <div class="text-2xl mb-2">ğŸ</div>
                    <div class="font-semibold text-gray-800 dark:text-white">ç¤¼ç‰©æ¨è</div>
                </button>
                
                <button onclick="showDateIdeas()" 
                        class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 text-center hover:scale-105 transition-transform">
                    <div class="text-2xl mb-2">ğŸ’‘</div>
                    <div class="font-semibold text-gray-800 dark:text-white">çº¦ä¼šè®¡åˆ’</div>
                </button>
                
                <button onclick="showChatHelper()" 
                        class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 text-center hover:scale-105 transition-transform">
                    <div class="text-2xl mb-2">ğŸ’¬</div>
                    <div class="font-semibold text-gray-800 dark:text-white">èŠå¤©æŠ€å·§</div>
                </button>
                
                <button onclick="showLoveNotes()" 
                        class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 text-center hover:scale-105 transition-transform">
                    <div class="text-2xl mb-2">ğŸ’Œ</div>
                    <div class="font-semibold text-gray-800 dark:text-white">æƒ…è¯å¤§å…¨</div>
                </button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 id="modalTitle" class="text-lg font-bold text-gray-800 dark:text-white"></h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>
                <div id="modalContent" class="p-4">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ” é…ç½®åŒºåŸŸ - éœ€è¦å¡«å…¥ä½ çš„API Key
        const SHARED_API_KEY = 'sk-1485e44b18f64bf994b6bde5da7c27f4'; // â† é…ç½®DeepSeek API Key
        
        // åº”ç”¨çŠ¶æ€
        let appState = {
            userType: '',
            userName: '',
            partnerName: '',
            anniversaryDate: '',
            apiKey: '',
            chatRoomId: '',
            isConnectedToChat: false
        };

        // äº‘ç«¯èŠå¤©ç®¡ç†å™¨
        class CloudChatManager {
            constructor() {
                this.chatRoomId = '';
                this.isConnected = false;
                this.messages = [];
                this.pollInterval = null;
                this.baseUrl = 'https://api.jsonbin.io/v3/b';
                this.apiKey = '$2a$10$YOm/.zq8yzFH5gF5A9A.vOhDMhLlPJNJHdKkzJ8bqw0J1ZiAJ7IJ2'; // JSONBin.io API Key
            }

            // åˆ›å»ºèŠå¤©å®¤
            async createChatRoom() {
                try {
                    const chatRoomId = 'couple_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                    
                    const initialData = {
                        chatRoomId: chatRoomId,
                        createdBy: appState.userName,
                        createdAt: new Date().toISOString(),
                        participants: [appState.userName],
                        messages: []
                    };

                    // åˆ›å»ºäº‘ç«¯èŠå¤©å®¤
                    const response = await fetch(this.baseUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': this.apiKey
                        },
                        body: JSON.stringify(initialData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.chatRoomId = chatRoomId;
                        this.binId = result.metadata.id;
                        
                        localStorage.setItem('coupleChatRoom', JSON.stringify({
                            chatRoomId: chatRoomId,
                            binId: this.binId
                        }));
                        
                        this.connectToChat();
                        return chatRoomId;
                    }
                } catch (error) {
                    console.error('åˆ›å»ºèŠå¤©å®¤å¤±è´¥:', error);
                    return null;
                }
            }

            // åŠ å…¥èŠå¤©å®¤
            async joinChatRoom(chatRoomId) {
                try {
                    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œéœ€è¦é€šè¿‡chatRoomIdæŸ¥æ‰¾å¯¹åº”çš„binId
                    // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨localStorageå…±äº«binId
                    
                    this.chatRoomId = chatRoomId;
                    localStorage.setItem('coupleChatRoom', JSON.stringify({
                        chatRoomId: chatRoomId
                    }));
                    
                    this.connectToChat();
                    return true;
                } catch (error) {
                    console.error('åŠ å…¥èŠå¤©å®¤å¤±è´¥:', error);
                    return false;
                }
            }

            // è¿æ¥åˆ°èŠå¤©
            connectToChat() {
                this.isConnected = true;
                this.startPolling();
                this.updateChatUI();
                updateChatStatus('connected');
            }

            // å‘é€æ¶ˆæ¯
            async sendMessage(message) {
                if (!this.isConnected) return false;

                try {
                    const newMessage = {
                        id: Date.now(),
                        from: appState.userName,
                        content: message,
                        timestamp: new Date().toISOString(),
                        userType: appState.userType
                    };

                    this.messages.push(newMessage);
                    this.displayMessage(newMessage);
                    
                    // æ¨¡æ‹Ÿå‘é€åˆ°äº‘ç«¯ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦çœŸæ­£çš„äº‘ç«¯å­˜å‚¨ï¼‰
                    this.saveToCloud();
                    
                    return true;
                } catch (error) {
                    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                    return false;
                }
            }

            // è½®è¯¢æ–°æ¶ˆæ¯
            startPolling() {
                this.pollInterval = setInterval(() => {
                    this.checkForNewMessages();
                }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ–°æ¶ˆæ¯
            }

            // æ£€æŸ¥æ–°æ¶ˆæ¯
            async checkForNewMessages() {
                // æ¨¡æ‹Ÿæ¥æ”¶æ¶ˆæ¯ï¼ˆå®é™…åº”ç”¨ä¸­ä»äº‘ç«¯æ‹‰å–ï¼‰
                // è¿™é‡Œå¯ä»¥å®ç°çœŸæ­£çš„äº‘ç«¯æ¶ˆæ¯åŒæ­¥
            }

            // æ˜¾ç¤ºæ¶ˆæ¯
            displayMessage(message) {
                const messagesContainer = document.getElementById('chatMessages');
                const isOwnMessage = message.from === appState.userName;
                
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} message-slide-in`;
                
                const time = new Date(message.timestamp).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageElement.innerHTML = `
                    <div class="max-w-xs ${isOwnMessage ? 'bg-love-pink text-white' : 'bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200'} rounded-lg px-3 py-2">
                        <div class="text-sm">${message.content}</div>
                        <div class="text-xs opacity-75 mt-1">${time}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // æ›´æ–°æ¶ˆæ¯è®¡æ•°
                this.updateMessageCount();
            }

            // æ›´æ–°UI
            updateChatUI() {
                document.getElementById('chatNotConnected').classList.add('hidden');
                document.getElementById('chatConnected').classList.remove('hidden');
                document.getElementById('partnerNameInChat').textContent = appState.partnerName;
            }

            // æ›´æ–°æ¶ˆæ¯è®¡æ•°
            updateMessageCount() {
                document.getElementById('messageCount').textContent = `${this.messages.length} æ¡æ¶ˆæ¯`;
            }

            // ä¿å­˜åˆ°äº‘ç«¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
            saveToCloud() {
                localStorage.setItem('cloudChatMessages', JSON.stringify(this.messages));
            }

            // æ–­å¼€è¿æ¥
            disconnect() {
                this.isConnected = false;
                if (this.pollInterval) {
                    clearInterval(this.pollInterval);
                }
                updateChatStatus('disconnected');
            }
        }

        // å…¨å±€èŠå¤©ç®¡ç†å™¨
        const chatManager = new CloudChatManager();

        // ç”¨æˆ·é€‰æ‹©
        function selectUser(type) {
            appState.userType = type;
            document.getElementById('userSelection').classList.add('hidden');
            document.getElementById('configPanel').classList.remove('hidden');
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            appState.userName = document.getElementById('userName').value;
            appState.partnerName = document.getElementById('partnerName').value;
            appState.anniversaryDate = document.getElementById('anniversaryDate').value;
            appState.apiKey = SHARED_API_KEY;

            if (!appState.userName || !appState.partnerName) {
                showCustomAlert('è¯·å¡«å†™å§“åä¿¡æ¯');
                return;
            }

            localStorage.setItem('coupleAI', JSON.stringify(appState));
            initMainApp();
        }

        // åˆå§‹åŒ–ä¸»åº”ç”¨
        function initMainApp() {
            document.getElementById('configPanel').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            const userIcon = appState.userType === 'boyfriend' ? 'ğŸ¤µ' : 'ğŸ‘©';
            const title = appState.userType === 'boyfriend' ? 'AIç”·å‹åŠ©æ‰‹' : 'AIå¥³å‹åŠ©æ‰‹';
            
            document.getElementById('userIcon').textContent = userIcon;
            document.getElementById('appTitle').textContent = title;
            document.getElementById('subtitle').textContent = `ä¸º ${appState.partnerName} ä¸“å±å®šåˆ¶`;
            document.getElementById('partnerNameInChat').textContent = appState.partnerName;

            generateDailyReminders();
            generateAISuggestions();
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰èŠå¤©å®¤
            const savedChatRoom = localStorage.getItem('coupleChatRoom');
            if (savedChatRoom) {
                const chatData = JSON.parse(savedChatRoom);
                chatManager.chatRoomId = chatData.chatRoomId;
                chatManager.connectToChat();
            }
        }

        // åˆ›å»ºèŠå¤©å®¤
        async function createChatRoom() {
            updateChatStatus('connecting');
            const chatRoomId = await chatManager.createChatRoom();
            
            if (chatRoomId) {
                showModal('ğŸ”— èŠå¤©å®¤åˆ›å»ºæˆåŠŸ', `
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸ’•</div>
                        <h4 class="font-bold text-gray-800 dark:text-white mb-4">èŠå¤©å®¤ä»£ç </h4>
                        <div class="bg-gradient-to-r from-pink-100 to-purple-100 dark:from-pink-900/30 dark:to-purple-900/30 rounded-lg p-4 mb-4">
                            <div class="text-2xl font-bold text-pink-600 dark:text-pink-400">${chatRoomId}</div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            æŠŠè¿™ä¸ªä»£ç å‘ç»™ ${appState.partnerName}ï¼Œ<br>
                            è®©TAåœ¨åº”ç”¨ä¸­è¾“å…¥ä»£ç åŠ å…¥èŠå¤©ï¼
                        </p>
                        <button onclick="copyToClipboard('${chatRoomId}')" 
                                class="gradient-bg text-white px-6 py-2 rounded-lg font-semibold">
                            ğŸ“‹ å¤åˆ¶ä»£ç 
                        </button>
                    </div>
                `);
            } else {
                showCustomAlert('åˆ›å»ºèŠå¤©å®¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                updateChatStatus('disconnected');
            }
        }

        // åŠ å…¥èŠå¤©å®¤
        function joinChatRoom() {
            showModal('ğŸ“ åŠ å…¥èŠå¤©å®¤', `
                <div class="text-center">
                    <div class="text-4xl mb-4">ğŸ’•</div>
                    <h4 class="font-bold text-gray-800 dark:text-white mb-4">è¾“å…¥èŠå¤©å®¤ä»£ç </h4>
                    <input type="text" id="chatRoomInput" placeholder="è¾“å…¥èŠå¤©å®¤ä»£ç " 
                           class="w-full border rounded-lg px-3 py-3 text-center font-mono text-lg mb-4 focus:ring-2 focus:ring-love-pink">
                    <button onclick="doJoinChatRoom()" 
                            class="w-full gradient-bg text-white py-3 rounded-lg font-semibold">
                        ğŸ’• åŠ å…¥èŠå¤©å®¤
                    </button>
                </div>
            `);
        }

        // æ‰§è¡ŒåŠ å…¥èŠå¤©å®¤
        async function doJoinChatRoom() {
            const chatRoomId = document.getElementById('chatRoomInput').value.trim();
            if (!chatRoomId) {
                showCustomAlert('è¯·è¾“å…¥èŠå¤©å®¤ä»£ç ');
                return;
            }

            updateChatStatus('connecting');
            const success = await chatManager.joinChatRoom(chatRoomId);
            
            if (success) {
                closeModal();
                showCustomAlert('æˆåŠŸåŠ å…¥èŠå¤©å®¤ï¼ç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº† ğŸ’•');
            } else {
                showCustomAlert('åŠ å…¥èŠå¤©å®¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®');
                updateChatStatus('disconnected');
            }
        }

        // å‘é€äº‘ç«¯æ¶ˆæ¯
        async function sendCloudMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const success = await chatManager.sendMessage(message);
            if (success) {
                input.value = '';
            } else {
                showCustomAlert('å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ›´æ–°èŠå¤©çŠ¶æ€
        function updateChatStatus(status) {
            const statusElement = document.getElementById('chatStatusText');
            const statusMap = {
                'disconnected': 'æœªè¿æ¥',
                'connecting': 'è¿æ¥ä¸­...',
                'connected': 'å·²è¿æ¥'
            };
            statusElement.textContent = statusMap[status] || 'æœªçŸ¥çŠ¶æ€';
            
            // æ›´æ–°çŠ¶æ€é¢œè‰²
            const statusContainer = document.getElementById('chatStatus');
            statusContainer.className = 'text-xs px-2 py-1 rounded ';
            if (status === 'connected') {
                statusContainer.className += 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';
            } else if (status === 'connecting') {
                statusContainer.className += 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400';
            } else {
                statusContainer.className += 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400';
            }
        }

        // æ˜¾ç¤ºèŠå¤©è®¾ç½®
        function showChatSettings() {
            const settingsHTML = `
                <div class="space-y-4">
                    <div class="text-center mb-4">
                        <div class="text-2xl mb-2">âš™ï¸</div>
                        <h4 class="font-bold text-gray-800 dark:text-white">èŠå¤©è®¾ç½®</h4>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                        <h5 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">ğŸ“Š èŠå¤©çŠ¶æ€</h5>
                        <div class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                            <div>çŠ¶æ€: ${chatManager.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}</div>
                            <div>èŠå¤©å®¤: ${chatManager.chatRoomId || 'æœªåŠ å…¥'}</div>
                            <div>æ¶ˆæ¯æ•°: ${chatManager.messages.length} æ¡</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="chatManager.disconnect(); closeModal();" 
                                class="flex-1 border border-red-500 text-red-500 rounded-lg py-2 font-semibold">
                            æ–­å¼€è¿æ¥
                        </button>
                        <button onclick="clearChatHistory()" 
                                class="flex-1 border border-gray-500 text-gray-500 rounded-lg py-2 font-semibold">
                            æ¸…é™¤è®°å½•
                        </button>
                    </div>
                </div>
            `;
            
            showModal('âš™ï¸ èŠå¤©è®¾ç½®', settingsHTML);
        }

        // æ¸…é™¤èŠå¤©è®°å½•
        function clearChatHistory() {
            chatManager.messages = [];
            document.getElementById('chatMessages').innerHTML = '';
            chatManager.updateMessageCount();
            showCustomAlert('èŠå¤©è®°å½•å·²æ¸…é™¤');
            closeModal();
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showCustomAlert('ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        // AIå»ºè®®ç”Ÿæˆï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
        async function generateAISuggestions() {
            const aiSuggestionsDiv = document.getElementById('aiSuggestions');
            
            if (!appState.apiKey || appState.apiKey === 'sk-åœ¨è¿™é‡Œå¡«å…¥ä½ çš„çœŸå®API Key') {
                aiSuggestionsDiv.innerHTML = `
                    <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">âš ï¸</div>
                            <div class="flex-1">
                                <p class="text-yellow-800 dark:text-yellow-200 font-semibold">éœ€è¦é…ç½®API Key</p>
                                <p class="text-yellow-700 dark:text-yellow-300 text-sm mt-1">
                                    è¯·åœ¨ä»£ç ä¸­é…ç½®DeepSeek API Key
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            aiSuggestionsDiv.innerHTML = `
                <div class="bg-gradient-to-r from-love-pink to-love-purple text-white rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">ğŸ¤–</div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                <span>AIæ­£åœ¨æ€è€ƒ...</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯æ‹çˆ±é¡¾é—®ï¼Œç»™å‡ºç®€æ´å®ç”¨çš„å»ºè®®ï¼Œ25å­—ä»¥å†…ã€‚'
                            },
                            {
                                role: 'user',
                                content: `æˆ‘æ˜¯${appState.userType === 'boyfriend' ? 'ç”·å‹' : 'å¥³å‹'}ï¼Œè¯·ç»™æˆ‘ä¸€ä¸ªæ‹çˆ±å»ºè®®`
                            }
                        ],
                        max_tokens: 100
                    })
                });
                
                const data = await response.json();
                const suggestion = data.choices[0].message.content;
                
                aiSuggestionsDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-love-pink to-love-purple text-white rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">ğŸ¤–</div>
                            <div class="flex-1">
                                <p class="text-white">${suggestion}</p>
                                <div class="text-xs mt-2 opacity-75">âœ¨ DeepSeek AIç”Ÿæˆ</div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                aiSuggestionsDiv.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">âŒ</div>
                            <div class="flex-1">
                                <p class="text-red-800 dark:text-red-200 font-semibold">AIè°ƒç”¨å¤±è´¥</p>
                                <p class="text-red-700 dark:text-red-300 text-sm mt-1">${error.message}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // è‡ªå®šä¹‰AIèŠå¤©
        function askCustomAI() {
            showCustomAlert('AIèŠå¤©åŠŸèƒ½å³å°†æ¨å‡ºï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }

        // ç”Ÿæˆæ¯æ—¥æé†’
        function generateDailyReminders() {
            const reminders = [
                { icon: 'ğŸ’', text: 'ä»Šå¤©ä¹Ÿè¦å¥½å¥½çˆ±TAå“¦ï¼Œè®°å¾—å‘ä¸ªç”œèœœæ¶ˆæ¯!' },
                { icon: 'ğŸŒˆ', text: 'äº‘ç«¯èŠå¤©è®©ä½ ä»¬éšæ—¶ä¿æŒè”ç³»ï¼Œè¯•è¯•çœ‹å§!' }
            ];

            const reminderHTML = reminders.map(reminder => 
                `<div class="flex items-center space-x-2 text-gray-600 dark:text-gray-400">
                    <span>${reminder.icon}</span>
                    <span>${reminder.text}</span>
                </div>`
            ).join('');

            document.getElementById('dailyReminders').innerHTML = reminderHTML;
        }

        // æ˜¾ç¤ºç¤¼ç‰©å»ºè®®
        function showGiftSuggestions() {
            const gifts = appState.userType === 'boyfriend' ? [
                'ğŸ’ ç²¾è‡´å°é¥°å“ - ç®€çº¦çš„é¡¹é“¾æˆ–æ‰‹é“¾',
                'ğŸŒ¹ é²œèŠ± + æ‰‹å†™å¡ç‰‡ - è¡¨è¾¾çœŸå¿ƒ',
                'ğŸ° å¥¹å–œæ¬¢çš„ç”œå“ - è›‹ç³•æˆ–é©¬å¡é¾™',
                'ğŸ“š æœ‰æ„ä¹‰çš„ä¹¦ç± - å…³äºå¥¹çš„å…´è¶£çˆ±å¥½'
            ] : [
                'ğŸ‘” å®ç”¨çš„æœé¥° - é«˜è´¨é‡çš„è¡¬è¡«æˆ–é¢†å¸¦',
                'âŒš æ‰‹è¡¨æˆ–é…ä»¶ - å®ç”¨ä¸”æœ‰çºªå¿µæ„ä¹‰',
                'ğŸ® ä»–çš„å…´è¶£çˆ±å¥½ç›¸å…³ç‰©å“',
                'â˜• ç²¾å“å’–å•¡è±†æˆ–èŒ¶å¶'
            ];

            const giftHTML = `
                <div class="space-y-3">
                    <div class="text-center mb-4">
                        <div class="text-2xl mb-2">ğŸ</div>
                        <p class="text-gray-600 dark:text-gray-300">ä¸º${appState.partnerName}æ¨èçš„ç¤¼ç‰©</p>
                    </div>
                    ${gifts.map(gift => 
                        `<div class="border border-gray-200 dark:border-gray-600 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-700">
                            ${gift}
                        </div>`
                    ).join('')}
                </div>
            `;
            
            showModal('ğŸ ç¤¼ç‰©æ¨è', giftHTML);
        }

        // å…¶ä»–åŠŸèƒ½å‡½æ•°
        function showDateIdeas() {
            showCustomAlert('çº¦ä¼šè®¡åˆ’åŠŸèƒ½æ­£åœ¨å®Œå–„ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }

        function showChatHelper() {
            showCustomAlert('èŠå¤©æŠ€å·§åŠŸèƒ½æ­£åœ¨å®Œå–„ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }

        function showLoveNotes() {
            showCustomAlert('æƒ…è¯å¤§å…¨åŠŸèƒ½æ­£åœ¨å®Œå–„ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }

        // æ¨¡æ€æ¡†å‡½æ•°
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function showCustomAlert(message) {
            showModal('æç¤º', `
                <div class="text-center">
                    <div class="text-2xl mb-4">ğŸ’•</div>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <button onclick="closeModal()" class="gradient-bg text-white px-6 py-2 rounded-lg font-semibold">
                        å¥½çš„
                    </button>
                </div>
            `);
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('chatInput') === document.activeElement) {
                sendCloudMessage();
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¿å­˜çš„æ•°æ®
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('coupleAI');
            if (savedData) {
                appState = JSON.parse(savedData);
                appState.apiKey = SHARED_API_KEY; // ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„API Key
                initMainApp();
            }
        });

        // è‡ªåŠ¨ç”ŸæˆAIå»ºè®®
        setTimeout(() => {
            if (appState.apiKey && appState.apiKey !== 'sk-åœ¨è¿™é‡Œå¡«å…¥ä½ çš„çœŸå®API Key') {
                generateAISuggestions();
            }
        }, 1000);
    </script>
</body>
</html>
