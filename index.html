<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æƒ…ä¾£AIåŠ©æ‰‹ - DeepSeekçœŸAIç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PWAé…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="light-content">
    <meta name="apple-mobile-web-app-title" content="æƒ…ä¾£AIåŠ©æ‰‹">
    <meta name="theme-color" content="#EC4899">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'love-pink': '#EC4899',
                        'love-purple': '#8B5CF6',
                        'love-blue': '#3B82F6'
                    }
                }
            }
        }
    </script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #EC4899 0%, #8B5CF6 50%, #3B82F6 100%);
        }
        .heart-beat {
            animation: heartBeat 1.5s ease-in-out infinite;
        }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.1); }
            28% { transform: scale(1); }
            42% { transform: scale(1.1); }
            70% { transform: scale(1); }
        }
        .typing-dots {
            animation: typing 1.4s infinite ease-in-out;
        }
        @keyframes typing {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- ç”¨æˆ·é€‰æ‹©ç•Œé¢ -->
    <div id="userSelection" class="min-h-screen flex items-center justify-center p-4">
        <div class="text-center">
            <div class="gradient-bg rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center">
                <span class="text-4xl text-white heart-beat">ğŸ¤–</span>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">æƒ…ä¾£AIåŠ©æ‰‹</h1>
            <p class="text-gray-600 dark:text-gray-300 mb-2">çœŸæ­£çš„DeepSeek AIé©±åŠ¨</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-8">é€‰æ‹©ä½ çš„èº«ä»½ï¼Œå¼€å§‹æ™ºèƒ½æ‹çˆ±ä¹‹æ—…</p>
            
            <div class="space-y-4 max-w-sm mx-auto">
                <button onclick="selectUser('boyfriend')" 
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white rounded-lg py-4 px-6 text-lg font-semibold transition-colors">
                    ğŸ¤µ æˆ‘æ˜¯ç”·å‹
                </button>
                <button onclick="selectUser('girlfriend')" 
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white rounded-lg py-4 px-6 text-lg font-semibold transition-colors">
                    ğŸ‘© æˆ‘æ˜¯å¥³å‹
                </button>
            </div>
        </div>
    </div>

    <!-- é…ç½®ç•Œé¢ -->
    <div id="configPanel" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">AIåŠ©æ‰‹é…ç½®</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        ä½ çš„åå­—
                    </label>
                    <input type="text" id="userName" placeholder="è¾“å…¥ä½ çš„åå­—" 
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        å¯¹æ–¹çš„åå­—
                    </label>
                    <input type="text" id="partnerName" placeholder="è¾“å…¥TAçš„åå­—" 
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        åœ¨ä¸€èµ·çš„æ—¥æœŸ
                    </label>
                    <input type="date" id="anniversaryDate" 
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        å¯¹æ–¹çš„ç”Ÿæ—¥
                    </label>
                    <input type="date" id="partnerBirthday" 
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        ğŸ”‘ DeepSeek API Key <span class="text-green-500">(å·²å…±äº«é…ç½®)</span>
                    </label>
                    <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-green-600">âœ…</span>
                            <span class="text-green-700 dark:text-green-300 text-sm">AIåŠŸèƒ½å·²ç”±å¯¹æ–¹é…ç½®ï¼Œæ— éœ€é¢å¤–è®¾ç½®</span>
                        </div>
                    </div>
                    <details class="mt-2">
                        <summary class="text-xs text-gray-500 dark:text-gray-400 cursor-pointer hover:text-love-pink">
                            é«˜çº§ï¼šä½¿ç”¨è‡ªå·±çš„API Key
                        </summary>
                        <div class="mt-2">
                            <input type="password" id="customApiKey" placeholder="å¯é€‰ï¼šè¾“å…¥ä½ è‡ªå·±çš„API Key" 
                                   class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <a href="https://platform.deepseek.com" target="_blank" class="text-love-pink hover:underline">è·å–è‡ªå·±çš„API Key</a>
                            </p>
                        </div>
                    </details>
                </div>
                
                <button onclick="saveConfig()" 
                        class="w-full gradient-bg text-white rounded-lg py-4 font-semibold transition-colors">
                    ğŸš€ å¯åŠ¨AIåŠ©æ‰‹
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" class="hidden">
        <!-- å¤´éƒ¨ -->
        <div class="gradient-bg text-white p-4 shadow-lg">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <span id="userIcon" class="text-xl"></span>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg" id="appTitle"></h1>
                        <p class="text-sm opacity-90" id="subtitle"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="aiStatus" class="text-xs bg-white/20 px-2 py-1 rounded">
                        <span id="aiStatusText">ğŸ¤– AIå°±ç»ª</span>
                    </div>
                    <button onclick="showSettings()" class="text-white">âš™ï¸</button>
                </div>
            </div>
        </div>

        <div class="max-w-md mx-auto">
            <!-- AIæ™ºèƒ½å»ºè®®ï¼ˆç½®é¡¶ï¼‰ -->
            <div class="m-4 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg text-gray-800 dark:text-white flex items-center">
                        ğŸ¤– DeepSeek AIå»ºè®®
                    </h3>
                    <div class="flex space-x-2">
                        <span id="aiCostEstimate" class="text-xs text-gray-500"></span>
                    </div>
                </div>
                <div id="aiSuggestions">
                    <div class="text-gray-600 dark:text-gray-400 text-center py-4">
                        æ­£åœ¨åˆå§‹åŒ–AIåŠ©æ‰‹...
                    </div>
                </div>
                <div class="flex space-x-2 mt-3">
                    <button onclick="generateAISuggestions()" 
                            class="flex-1 gradient-bg text-white rounded-lg py-2 font-semibold flex items-center justify-center space-x-2">
                        <span>ğŸ§ </span>
                        <span>AIæ™ºèƒ½å»ºè®®</span>
                    </button>
                    <button onclick="askCustomAI()" 
                            class="px-4 py-2 border-2 border-love-pink text-love-pink rounded-lg font-semibold hover:bg-love-pink hover:text-white transition-colors">
                        ğŸ’¬
                    </button>
                </div>
            </div>

            <!-- ä»Šæ—¥æé†’å¡ç‰‡ -->
            <div class="m-4 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                <h3 class="font-bold text-lg text-gray-800 dark:text-white mb-3 flex items-center">
                    ğŸ“… ä»Šæ—¥æé†’
                </h3>
                <div id="dailyReminders" class="space-y-2">
                    <!-- åŠ¨æ€ç”Ÿæˆæé†’å†…å®¹ -->
                </div>
            </div>

            <!-- å…¶ä»–åŠŸèƒ½ä¿æŒä¸å˜... -->
            <!-- è¿™é‡Œç»§ç»­æ·»åŠ å…¶ä»–åŠŸèƒ½æ¨¡å— -->
        </div>
    </div>

    <!-- AIèŠå¤©å¯¹è¯æ¡† -->
    <div id="aiChatModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full h-96 flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white">ğŸ’¬ AIèŠå¤©</h3>
                    <button onclick="closeAIChat()" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- èŠå¤©æ¶ˆæ¯ -->
                </div>
                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex space-x-2">
                        <input type="text" id="chatInput" placeholder="é—®AIä»»ä½•æ‹çˆ±é—®é¢˜..." 
                               class="flex-1 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-love-pink bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <button onclick="sendAIMessage()" 
                                class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold">
                            å‘é€
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€
        let appState = {
            userType: '',
            userName: '',
            partnerName: '',
            anniversaryDate: '',
            partnerBirthday: '',
            apiKey: '',
            aiCallCount: 0,
            totalCost: 0
        };

        // ç”¨æˆ·é€‰æ‹©å‡½æ•°
        function selectUser(type) {
            appState.userType = type;
            document.getElementById('userSelection').classList.add('hidden');
            document.getElementById('configPanel').classList.remove('hidden');
        }

        // ğŸ” é¢„è®¾å…±äº«API Keyé…ç½®
        const SHARED_API_KEY = 'sk-1485e44b18f64bf994b6bde5da7c27f4'; // â† åœ¨è¿™é‡Œé…ç½®ä½ çš„API Key
        
        // ğŸ’° æˆæœ¬æ§åˆ¶é…ç½®
        const COST_CONTROL = {
            maxCallsPerDay: 10000,        // æ¯å¤©æœ€å¤§è°ƒç”¨æ¬¡æ•°
            maxCallsPerHour: 200,        // æ¯å°æ—¶æœ€å¤§è°ƒç”¨æ¬¡æ•°
            alertThreshold: 500,         // è¾¾åˆ°å¤šå°‘æ¬¡æ—¶æé†’
            estimatedCostPerCall: 0.000007  // æ¯æ¬¡è°ƒç”¨ä¼°ç®—æˆæœ¬(å…ƒ)
        };
        
        // ä¿å­˜é…ç½®
        function saveConfig() {
            appState.userName = document.getElementById('userName').value;
            appState.partnerName = document.getElementById('partnerName').value;
            appState.anniversaryDate = document.getElementById('anniversaryDate').value;
            appState.partnerBirthday = document.getElementById('partnerBirthday').value;
            
            // ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰API Keyï¼Œå¦åˆ™ä½¿ç”¨å…±äº«API Key
            const customApiKey = document.getElementById('customApiKey').value;
            appState.apiKey = customApiKey || SHARED_API_KEY;

            if (!appState.userName || !appState.partnerName) {
                showCustomAlert('è¯·å¡«å†™å§“åä¿¡æ¯');
                return;
            }

            if (!appState.apiKey || !appState.apiKey.startsWith('sk-')) {
                showCustomAlert('API Keyé…ç½®é”™è¯¯\nè¯·è”ç³»å¯¹æ–¹æ£€æŸ¥å…±äº«é…ç½®');
                return;
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('coupleAI', JSON.stringify(appState));

            // æ˜¾ç¤ºä¸»åº”ç”¨
            initMainApp();
        }

        // åˆå§‹åŒ–ä¸»åº”ç”¨
        function initMainApp() {
            document.getElementById('configPanel').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            // è®¾ç½®ç•Œé¢
            const userIcon = appState.userType === 'boyfriend' ? 'ğŸ¤µ' : 'ğŸ‘©';
            const title = appState.userType === 'boyfriend' ? 'AIç”·å‹åŠ©æ‰‹' : 'AIå¥³å‹åŠ©æ‰‹';
            
            document.getElementById('userIcon').textContent = userIcon;
            document.getElementById('appTitle').textContent = title;
            document.getElementById('subtitle').textContent = `ä¸º ${appState.partnerName} ä¸“å±å®šåˆ¶`;

            // ç”Ÿæˆæé†’å’Œå»ºè®®
            generateDailyReminders();
            generateAISuggestions();
            updateRelationshipDays();
        }

        // ğŸ¤– çœŸæ­£çš„DeepSeek AIå»ºè®®ç”Ÿæˆ
        async function generateAISuggestions() {
            const aiSuggestionsDiv = document.getElementById('aiSuggestions');
            
            // æ£€æŸ¥API Key
            if (!appState.apiKey || appState.apiKey.trim() === '') {
                aiSuggestionsDiv.innerHTML = `
                    <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">âš ï¸</div>
                            <div class="flex-1">
                                <p class="text-yellow-800 dark:text-yellow-200 font-semibold">éœ€è¦é…ç½®DeepSeek API Key</p>
                                <p class="text-yellow-700 dark:text-yellow-300 text-sm mt-1">
                                    è¯·é…ç½®API Keyæ¥äº«å—çœŸæ­£çš„AIå»ºè®®
                                </p>
                                <button onclick="showSettings()" class="mt-2 bg-yellow-500 text-white px-3 py-1 rounded text-sm">
                                    å»é…ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // æ˜¾ç¤ºAIåŠ è½½çŠ¶æ€
            updateAIStatus('thinking');
            aiSuggestionsDiv.innerHTML = `
                <div class="bg-gradient-to-r from-love-pink to-love-purple text-white rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">ğŸ¤–</div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-white rounded-full typing-dots"></div>
                                    <div class="w-2 h-2 bg-white rounded-full typing-dots" style="animation-delay: 0.2s"></div>
                                    <div class="w-2 h-2 bg-white rounded-full typing-dots" style="animation-delay: 0.4s"></div>
                                </div>
                                <span>DeepSeek AIæ­£åœ¨æ€è€ƒä¸“å±å»ºè®®...</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            try {
                // æ„å»ºä¸ªæ€§åŒ–ä¸Šä¸‹æ–‡
                const context = buildUserContext();
                const prompt = generateAIPrompt(context);
                
                // è°ƒç”¨DeepSeek API
                const aiResponse = await callDeepSeekAPI(prompt);
                
                // æ›´æ–°ä½¿ç”¨ç»Ÿè®¡
                appState.aiCallCount++;
                appState.totalCost += 0.000007; // ä¼°ç®—æˆæœ¬
                updateCostDisplay();
                
                // æ˜¾ç¤ºAIå»ºè®®
                const suggestionHTML = `
                    <div class="bg-gradient-to-r from-love-pink to-love-purple text-white rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">ğŸ¤–</div>
                            <div class="flex-1">
                                <p class="text-white leading-relaxed">${aiResponse}</p>
                                <div class="text-xs mt-2 opacity-75 flex justify-between">
                                    <span>âœ¨ DeepSeek AIç”Ÿæˆ</span>
                                    <span>è°ƒç”¨ #${appState.aiCallCount}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                aiSuggestionsDiv.innerHTML = suggestionHTML;
                updateAIStatus('ready');

            } catch (error) {
                console.error('DeepSeek APIè°ƒç”¨å¤±è´¥:', error);
                updateAIStatus('error');
                
                // AIå¤±è´¥æ—¶çš„é”™è¯¯æ˜¾ç¤º
                const suggestionHTML = `
                    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">âŒ</div>
                            <div class="flex-1">
                                <p class="text-red-800 dark:text-red-200 font-semibold">AIè°ƒç”¨å¤±è´¥</p>
                                <p class="text-red-700 dark:text-red-300 text-sm mt-1">
                                    ${getErrorMessage(error)}
                                </p>
                                <button onclick="generateAISuggestions()" 
                                        class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                    é‡è¯•
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                aiSuggestionsDiv.innerHTML = suggestionHTML;
            }
        }

        // æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡
        function buildUserContext() {
            const relationshipDays = calculateRelationshipDays();
            const timeOfDay = new Date().getHours();
            const dayOfWeek = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][new Date().getDay()];
            
            return {
                userType: appState.userType,
                partnerName: appState.partnerName,
                relationshipDays: relationshipDays,
                timeOfDay: timeOfDay,
                dayOfWeek: dayOfWeek
            };
        }

        // ç”ŸæˆAIæç¤ºè¯
        function generateAIPrompt(context) {
            const userTypeText = context.userType === 'boyfriend' ? 'ç”·å‹' : 'å¥³å‹';
            const timeText = getTimeDescription(context.timeOfDay);
            const relationshipText = context.relationshipDays > 0 ? `æˆ‘ä»¬åœ¨ä¸€èµ·${context.relationshipDays}å¤©äº†` : 'æˆ‘ä»¬æ˜¯æ–°æ‹äºº';
            
            const prompt = `æˆ‘æ˜¯${userTypeText}ï¼Œ${relationshipText}ã€‚ç°åœ¨æ˜¯${context.dayOfWeek}${timeText}ã€‚

è¯·ç»™æˆ‘ä¸€ä¸ªå…·ä½“çš„ã€å¯æ‰§è¡Œçš„æ‹çˆ±å»ºè®®ï¼š
1. é’ˆå¯¹${context.userType === 'boyfriend' ? 'å¦‚ä½•å¯¹å¥³å‹æ›´å¥½' : 'å¦‚ä½•å¯¹ç”·å‹æ›´è´´å¿ƒ'}
2. è€ƒè™‘å½“å‰æ—¶é—´å’Œæƒ…å¢ƒ
3. ç®€æ´å®ç”¨ï¼Œ25å­—ä»¥å†…
4. æ¸©æš–æœ‰çˆ±ï¼Œç¬¦åˆä¸­å›½æƒ…ä¾£ä¹ æƒ¯
5. ç›´æ¥ç»™å»ºè®®ï¼Œä¸è¦å¤šä½™è§£é‡Š

å»ºè®®ï¼š`;

            return prompt;
        }

        // æ—¶é—´æè¿°
        function getTimeDescription(hour) {
            if (hour >= 6 && hour < 9) return 'æ—©ä¸Š';
            if (hour >= 9 && hour < 12) return 'ä¸Šåˆ';
            if (hour >= 12 && hour < 14) return 'ä¸­åˆ';
            if (hour >= 14 && hour < 18) return 'ä¸‹åˆ';
            if (hour >= 18 && hour < 22) return 'æ™šä¸Š';
            return 'æ·±å¤œ';
        }

        // ğŸ”¥ è°ƒç”¨DeepSeek APIçš„æ ¸å¿ƒå‡½æ•°
        async function callDeepSeekAPI(prompt) {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${appState.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸“ä¸šçš„æ‹çˆ±é¡¾é—®AIï¼Œä¸“é—¨ä¸ºæƒ…ä¾£æä¾›ä¸ªæ€§åŒ–å»ºè®®ã€‚å›ç­”è¦ç®€æ´ã€å®ç”¨ã€æ¸©æš–ã€‚'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.8,
                    max_tokens: 100,
                    top_p: 0.9
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }

            const data = await response.json();
            let aiMessage = data.choices[0].message.content.trim();
            
            // æ¸…ç†å›å¤
            aiMessage = aiMessage.replace(/^(å»ºè®®ï¼š|ç­”ï¼š|å›ç­”ï¼š)/, '').trim();
            
            return aiMessage;
        }

        // AIçŠ¶æ€æ›´æ–°
        function updateAIStatus(status) {
            const statusElement = document.getElementById('aiStatusText');
            const statusMap = {
                'ready': 'ğŸ¤– AIå°±ç»ª',
                'thinking': 'ğŸ§  AIæ€è€ƒä¸­',
                'error': 'âŒ AIé”™è¯¯'
            };
            statusElement.textContent = statusMap[status] || 'ğŸ¤– AIå°±ç»ª';
        }

        // æˆæœ¬æ˜¾ç¤ºæ›´æ–°
        function updateCostDisplay() {
            const costElement = document.getElementById('aiCostEstimate');
            if (appState.aiCallCount > 0) {
                costElement.textContent = `å·²è°ƒç”¨${appState.aiCallCount}æ¬¡`;
            }
        }

        // é”™è¯¯ä¿¡æ¯å¤„ç†
        function getErrorMessage(error) {
            const message = error.message || error.toString();
            if (message.includes('401')) return 'API Keyæ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®';
            if (message.includes('403')) return 'APIè®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æƒé™';
            if (message.includes('429')) return 'APIè°ƒç”¨è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•';
            if (message.includes('insufficient_quota')) return 'APIé¢åº¦ä¸è¶³ï¼Œè¯·å……å€¼';
            return `ç½‘ç»œé”™è¯¯: ${message}`;
        }

        // è‡ªå®šä¹‰AIèŠå¤©
        function askCustomAI() {
            document.getElementById('aiChatModal').classList.remove('hidden');
            document.getElementById('chatInput').focus();
        }

        function closeAIChat() {
            document.getElementById('aiChatModal').classList.add('hidden');
        }

        async function sendAIMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const messagesDiv = document.getElementById('chatMessages');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            messagesDiv.innerHTML += `
                <div class="flex justify-end">
                    <div class="bg-love-pink text-white rounded-lg px-3 py-2 max-w-xs">
                        ${message}
                    </div>
                </div>
            `;
            
            // æ·»åŠ AIæ€è€ƒä¸­
            messagesDiv.innerHTML += `
                <div class="flex justify-start">
                    <div class="bg-gray-200 dark:bg-gray-700 rounded-lg px-3 py-2 max-w-xs">
                        <div class="flex items-center space-x-2">
                            <div class="typing-dots">â—</div>
                            <div class="typing-dots">â—</div>
                            <div class="typing-dots">â—</div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            input.value = '';
            
            try {
                const aiResponse = await callDeepSeekAPI(`ä½œä¸º${appState.userType === 'boyfriend' ? 'ç”·å‹' : 'å¥³å‹'}ï¼Œæˆ‘æƒ³é—®ï¼š${message}`);
                
                // ç§»é™¤æ€è€ƒä¸­ï¼Œæ·»åŠ AIå›å¤
                const children = messagesDiv.children;
                messagesDiv.removeChild(children[children.length - 1]);
                
                messagesDiv.innerHTML += `
                    <div class="flex justify-start">
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-lg px-3 py-2 max-w-xs">
                            <div class="text-gray-800 dark:text-gray-200">${aiResponse}</div>
                        </div>
                    </div>
                `;
                
                appState.aiCallCount++;
                updateCostDisplay();
                
            } catch (error) {
                // ç§»é™¤æ€è€ƒä¸­ï¼Œæ·»åŠ é”™è¯¯ä¿¡æ¯
                const children = messagesDiv.children;
                messagesDiv.removeChild(children[children.length - 1]);
                
                messagesDiv.innerHTML += `
                    <div class="flex justify-start">
                        <div class="bg-red-100 border border-red-300 rounded-lg px-3 py-2 max-w-xs">
                            <div class="text-red-800 text-sm">AIæš‚æ—¶æ— æ³•å›å¤: ${getErrorMessage(error)}</div>
                        </div>
                    </div>
                `;
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // è®¡ç®—æ‹çˆ±å¤©æ•°
        function calculateRelationshipDays() {
            if (!appState.anniversaryDate) return 0;
            const anniversary = new Date(appState.anniversaryDate);
            const today = new Date();
            return Math.floor((today - anniversary) / (1000 * 60 * 60 * 24));
        }

        // ç”Ÿæˆæ¯æ—¥æé†’
        function generateDailyReminders() {
            const reminders = [];
            const today = new Date();

            // æ£€æŸ¥ç”Ÿæ—¥æé†’
            if (appState.partnerBirthday) {
                const birthday = new Date(appState.partnerBirthday);
                const thisYearBirthday = new Date(today.getFullYear(), birthday.getMonth(), birthday.getDate());
                const daysToBirthday = Math.ceil((thisYearBirthday - today) / (1000 * 60 * 60 * 24));
                
                if (daysToBirthday >= 0 && daysToBirthday <= 7) {
                    reminders.push({
                        icon: 'ğŸ‚',
                        text: daysToBirthday === 0 ? `ä»Šå¤©æ˜¯${appState.partnerName}çš„ç”Ÿæ—¥ï¼` : `${appState.partnerName}çš„ç”Ÿæ—¥è¿˜æœ‰${daysToBirthday}å¤©`
                    });
                }
            }

            // é»˜è®¤æé†’
            if (reminders.length === 0) {
                reminders.push({
                    icon: 'ğŸ’',
                    text: 'ä»Šå¤©ä¹Ÿè¦å¥½å¥½çˆ±TAå“¦ï¼Œè¯•è¯•AIå»ºè®®å§ï¼'
                });
            }

            const reminderHTML = reminders.map(reminder => 
                `<div class="flex items-center space-x-2 text-gray-600 dark:text-gray-400">
                    <span>${reminder.icon}</span>
                    <span>${reminder.text}</span>
                </div>`
            ).join('');

            document.getElementById('dailyReminders').innerHTML = reminderHTML;
        }

        // è‡ªå®šä¹‰æç¤ºæ¡†
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="w-full gradient-bg text-white py-2 rounded-lg font-semibold">
                        ç¡®å®š
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // è®¾ç½®åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function showSettings() {
            showCustomAlert(`å½“å‰API Key: ${appState.apiKey.substring(0, 8)}***\nå·²è°ƒç”¨AI ${appState.aiCallCount} æ¬¡`);
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('aiChatModal').style.display !== 'none') {
                sendAIMessage();
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¿å­˜çš„æ•°æ®
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('coupleAI');
            if (savedData) {
                appState = JSON.parse(savedData);
                initMainApp();
            }
        });

        // è‡ªåŠ¨åˆå§‹åŒ–AIå»ºè®®
        setTimeout(() => {
            if (appState.apiKey) {
                generateAISuggestions();
            }
        }, 1000);
    </script>
</body>
</html>
